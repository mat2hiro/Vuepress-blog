(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{218:function(a,t,o){"use strict";o.r(t);var e=o(0),r=Object(e.a)({},(function(){var a=this,t=a.$createElement,o=a._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[o("h2",{attrs:{id:"ポイント"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#ポイント"}},[a._v("#")]),a._v(" ポイント")]),a._v(" "),o("ul",[o("li",[a._v("backlogのwebhook機能を使って、課題作成、更新などの通知をslackに流す")]),a._v(" "),o("li",[a._v("Google cloud functionsで運用\n")])]),a._v(" "),o("h2",{attrs:{id:"動機"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#動機"}},[a._v("#")]),a._v(" 動機")]),a._v(" "),o("p",[a._v("slackでチャットして、backlogでタスク管理や要件のスタックをしている。")]),a._v(" "),o("p",[a._v("基本slackのチャンネルにいるので、タスクが割り振られたときや更新されたときはslackで確認したい。")]),a._v(" "),o("p",[a._v("公式の連携サービスもあるが、もう少し機能を限定してカスタマイズしたかったのでbotを作った。")]),a._v(" "),o("h2",{attrs:{id:"要件"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#要件"}},[a._v("#")]),a._v(" 要件")]),a._v(" "),o("p",[a._v("各backlogプロジェクトの通知を流すslackチャンネルが存在し、課題追加などの通知を（知らせたい人へのメンション付きで）そのチャンネルに流したい")]),a._v(" "),o("p",[a._v("尚、slackアカウントのメールアドレスとnulabアカウントのメールアドレスは同一のものとする")]),a._v(" "),o("p",[a._v("backlogのwebhookへの登録も手間なので、通知流したいチャンネルからのスラッシュコマンド一発でwebhookの登録もしたい")]),a._v(" "),o("h2",{attrs:{id:"できた"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#できた"}},[a._v("#")]),a._v(" できた")]),a._v(" "),o("p",[o("a",{attrs:{href:"https://github.com/mat2hiro/backlog-to-slack-notification",target:"_blank",rel:"noopener noreferrer"}},[a._v("このリポジトリ"),o("OutboundLink")],1)]),a._v(" "),o("h3",{attrs:{id:"導入方法"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#導入方法"}},[a._v("#")]),a._v(" 導入方法")]),a._v(" "),o("ol",[o("li",[o("p",[a._v("slack app")]),a._v(" "),o("p",[o("a",{attrs:{href:"https://slack.com/intl/ja-jp/help/articles/202035138",target:"_blank",rel:"noopener noreferrer"}},[a._v("slack appの追加"),o("OutboundLink")],1),a._v("、slash commandの追加を参照"),o("br"),a._v("\nappのトークンと、slash commandの秘密鍵をメモっとく")])]),a._v(" "),o("li",[o("p",[a._v("backlog")]),a._v(" "),o("p",[a._v("自身の属するbacklog groupのurlと、backlog api tokenをメモ")])]),a._v(" "),o("li",[o("p",[a._v("Google cloud functions")]),a._v(" "),o("p",[a._v("まずGCPプロジェクトがない場合は作る。"),o("a",{attrs:{href:"https://cloud.google.com/functions/docs/quickstart-nodejs?hl=ja",target:"_blank",rel:"noopener noreferrer"}},[a._v("Node.js クイックスタート"),o("OutboundLink")],1)]),a._v(" "),o("p",[a._v("上記リポジトリをcloneして、READMEのとおりにgoogle cloud functionsにデプロイする。"),o("a",{attrs:{href:"https://cloud.google.com/functions/docs/quickstart?hl=ja",target:"_blank",rel:"noopener noreferrer"}},[a._v("クイックスタート: gcloud コマンドライン ツールの使用"),o("OutboundLink")],1),o("br"),a._v("\nこの際の環境変数はさっきメモしたやつら"),o("br"),a._v("\nデプロイしたら、トリガーとなるurlをメモ")])]),a._v(" "),o("li",[o("p",[a._v("slack")]),a._v(" "),o("p",[a._v("先程追加したslash commandのurlに3.のurl+/setupを記入")])])]),a._v(" "),o("p",[a._v("これで導入は完了")]),a._v(" "),o("h3",{attrs:{id:"使い方"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#使い方"}},[a._v("#")]),a._v(" 使い方")]),a._v(" "),o("p",[a._v("通知を連携したいチャンネルにslack appを招待し、スラッシュコマンドを実行する")]),a._v(" "),o("p",[o("img",{attrs:{src:"https://i.gyazo.com/426f0e6ed578129c5d154696d11f75c2.png",alt:"スラッシュコマンド打つ"}})]),a._v(" "),o("p",[a._v("すると、チャンネル名と一致する名前のプロジェクトに、通知をこのチャンネルに飛ばすような設定がなされる")]),a._v(" "),o("p",[o("img",{attrs:{src:"https://i.gyazo.com/7590cf0f71b33af80c24cd06dc818137.png",alt:"設定完了通知来る"}})]),a._v(" "),o("p",[a._v("あとはbacklogの該当するプロジェクトで課題追加したりすると通知メッセが飛ぶのが確認できる")]),a._v(" "),o("p",[o("img",{attrs:{src:"https://i.gyazo.com/e6d3944aeb61c5ceae486cbef2bf5248.png",alt:"通知くる"}})]),a._v(" "),o("p",[o("img",{attrs:{src:"https://i.gyazo.com/3d975cae005dabcda5cae6034aa234f4.png",alt:"メンションもつく"}})]),a._v(" "),o("p",[a._v("ほぼ黒塗りの海苔弁状態で笑っちゃった")]),a._v(" "),o("h2",{attrs:{id:"実装"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#実装"}},[a._v("#")]),a._v(" 実装")]),a._v(" "),o("h3",{attrs:{id:"backlog-slack-via-webhook"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#backlog-slack-via-webhook"}},[a._v("#")]),a._v(" backlog -> slack (via webhook)")]),a._v(" "),o("p",[a._v("基本はこのコード("),o("a",{attrs:{href:"https://qiita.com/u-minor/items/57e68dd183925b3e6897",target:"_blank",rel:"noopener noreferrer"}},[a._v("API Gateway + Lambda を使って Backlog 通知を Slack で受け取る"),o("OutboundLink")],1),a._v(")を使っている")]),a._v(" "),o("p",[a._v("これをいくらかカスタマイズして、")]),a._v(" "),o("ol",[o("li",[a._v("リクエストのクエリによって通知メッセージを飛ばすチャンネルを変える")]),a._v(" "),o("li",[a._v("通知したいユーザーにメンションを付ける")]),a._v(" "),o("li",[a._v("課題の状態に合わせたメッセージの色付けをする")]),a._v(" "),o("li",[a._v("課題の状態が変化したことを通知する場合は、変化前->変化後のように表示する")])]),a._v(" "),o("p",[a._v("機能を追加したり、node slack sdkからslack apiを叩くようにしたりした。（エラーが減る）")]),a._v(" "),o("p",[a._v("結果（"),o("a",{attrs:{href:"https://github.com/mat2hiro/backlog-to-slack-notification/blob/f0aece3ceb5b3810dc74b8eecb4eb73273888e26/api.js#L5",target:"_blank",rel:"noopener noreferrer"}},[a._v("関数名chat"),o("OutboundLink")],1),a._v("）")]),a._v(" "),o("h3",{attrs:{id:"slack-backlog-webhook-setup-via-slash-command"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#slack-backlog-webhook-setup-via-slash-command"}},[a._v("#")]),a._v(" slack -> backlog webhook setup (via slash command)")]),a._v(" "),o("p",[a._v("まあよくあるスラッシュコマンドのやつ")]),a._v(" "),o("p",[a._v("コマンドからリクエストが飛んだら、")]),a._v(" "),o("ol",[o("li",[a._v("リクエスト送信元が認証済みのものか確認")]),a._v(" "),o("li",[a._v("slackのチャンネル名から該当のbacklogプロジェクトを探す")]),a._v(" "),o("li",[a._v("backlog apiを叩いてプロジェクトにwebhookを登録")])]),a._v(" "),o("p",[a._v("上記をしている。（"),o("a",{attrs:{href:"https://github.com/mat2hiro/backlog-to-slack-notification/blob/f0aece3ceb5b3810dc74b8eecb4eb73273888e26/api.js#L77",target:"_blank",rel:"noopener noreferrer"}},[a._v("関数名setup"),o("OutboundLink")],1),a._v("）")]),a._v(" "),o("h2",{attrs:{id:"future-works"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#future-works"}},[a._v("#")]),a._v(" future works")]),a._v(" "),o("p",[a._v("backlogではbold表記が*2個囲みだったりして、slackとずれているので、そのへんを置換したい（正規表現で頑張る他ないか）")]),a._v(" "),o("p",[a._v("また、機能はいろいろ調整したいが、その都度functions deployするのも面倒なので、デプロイ部分はciに丸投げしたい。")]),a._v(" "),o("p",[a._v("あと、リクエスト元がbacklogだったりslackだったりするので、functionsを別々にしたほうがいいのかな")])])}),[],!1,null,null,null);t.default=r.exports}}]);